---
import Layout from "@/layouts/Layout.astro";
import Button from "@/components/atoms/Button.astro";
import Google from "@/assets/icons/google.svg";
import EyeIcon from "@/assets/icons/eye.svg";
---

<Layout title="Registro">
	<main transition:name="main">
		<img src="/favicon.svg" alt="Logo" transition:name="logo" />

		<h1 transition:name="title">Registrarse</h1>

		<form
			transition:name="form"
			x-data="registerForm"
			@submit.prevent="handleRegister"
		>
			<p x-show="error" class="error" x-text="error"></p>

			<label transition:name="name-label">
				<span>Nombre Completo:</span>
				<input
					type="text"
					placeholder="Juan Pérez"
					required
					name="name"
					autocomplete="name"
					transition:name="name-input"
				/>
			</label>

			<label transition:name="email-label">
				<span>Email: </span>
				<input
					type="email"
					placeholder="example@example.com"
					required
					name="email"
					transition:name="email-input"
					autocomplete="email"
				/>
			</label>

			<label transition:name="password-label">
				<span>Contraseña:</span>
				<div transition:name="password-container">
					<input
						:type="showPassword ? 'text' : 'password'"
						:placeholder="showPassword ? 'Contraseña' : '********'"
						required
						name="password"
						transition:name="password-input"
						autocomplete="new-password"
					/>
					<span
						class="eye"
						transition:name="password-eye"
						@click="showPassword = !showPassword"
					>
						<EyeIcon width={24} height={24} />
					</span>
				</div>
			</label>

			<label transition:name="confirm-password-label">
				<span>Confirmar Contraseña:</span>
				<div transition:name="confirm-password-container">
					<input
						:type="showConfirmPassword ? 'text' : 'password'"
						:placeholder="showConfirmPassword ? 'Confirmar Contraseña' : '********'"
						required
						name="confirmPassword"
						transition:name="confirm-password-input"
					/>
					<span
						class="eye"
						transition:name="confirm-password-eye"
						@click="showConfirmPassword = !showConfirmPassword"
					>
						<EyeIcon width={24} height={24} />
					</span>
				</div>
			</label>

			<label transition:name="username-label">
				<span>Nombre de Usuario: </span>
				<input
					type="text"
					placeholder="Juan123"
					name="username"
					transition:name="username-input"
					required
				/>
			</label>

			<Button variant="primary" transition:name="primary-button"
				>Registrarse</Button
			>
		</form>

		<hr transition:name="divider" />

		<Button variant="secondary" transition:name="google-button">
			<Google width={24} height={24} />
			<span> Iniciar Sesion con Google </span>
		</Button>

		<p transition:name="switch-text">
			¿Ya tienes una cuenta? <a
				href="/auth/login"
				transition:name="switch-link">Inicia Sesión</a
			>
		</p>
	</main>
</Layout>

<script>
	import Alpine from "alpinejs";
	import { API_URL } from "@/services/constants";
	import { navigate } from "astro:transitions/client";

	interface RegisterFormData {
		showPassword: boolean;
		showConfirmPassword: boolean;
		error: string | null;
		handleRegister(e: SubmitEvent): Promise<void>;
	}

	document.addEventListener("alpine:init", () => {
		Alpine.data<RegisterFormData, []>("registerForm", () => ({
			showPassword: false,
			showConfirmPassword: false,
			error: null,
			async handleRegister(e: SubmitEvent) {
				e.preventDefault();
				const form = e.target as HTMLFormElement;
				const formData = new FormData(form);

				// Pass formData to JSON
				const data = Object.fromEntries(formData.entries()) as {
					name: string;
					email: string;
					password: string;
					confirmPassword: string;
					username: string;
				};

				try {
					await register(data);
					navigate("/");
				} catch (error) {
					this.error =
						(error as Error).message || "Error al registrarse";
				} finally {
					form.reset();
				}
			},
		}));
	});

	async function register(data: {
		name: string;
		email: string;
		password: string;
		confirmPassword: string;
		username: string;
	}) {
		const res = await fetch(`${API_URL}/api/v1/auth/register`, {
			method: "POST",
			credentials: "include", // Include cookies for session management
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify(data),
		});

		const resData = await res.json();
		if (!res.ok) {
			throw new Error(resData.error || "Error al registrarse");
		}
		return resData;
	}
</script>

<style>
	body {
		min-height: 100dvh;
		display: grid;
		place-items: center;
		background: radial-gradient(
			circle at center,
			var(--background-color),
			var(--middle-color)
		);
	}

	main h1 {
		text-align: center;
	}

	main {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-lg);
		padding: 2rem 4rem;
		border-radius: 0.5rem;
		width: clamp(300px, 90%, 500px);
		background-color: var(--middle-color);
	}

	main img {
		width: 100px;
		height: 100px;
		margin: 0 auto;
	}

	form {
		display: flex;
		flex-direction: column;
		gap: var(--spacing-md);
	}

	label {
		display: flex;
		flex-direction: column;
		user-select: none;
	}

	label > span {
		margin-bottom: 0.25rem;
		font-weight: bold;
	}

	input {
		padding: 0.5rem 0.75rem;
		border-radius: 0.75rem;
		border: none;

		outline: 1px solid var(--border-color);
		background-color: var(--background-color);
		transition: border-color 0.2s ease-in-out;
		width: 100%;

		&:focus {
			border-color: var(--primary);
			outline: none;
		}

		&::placeholder {
			color: var(--text-muted);
		}
	}

	button {
		justify-content: center;
	}

	main > p {
		text-align: center;
	}

	a {
		color: var(--primary-dark);
	}

	.eye {
		position: absolute;
		right: 0.75rem;
	}

	label div {
		position: relative;
		display: flex;
		align-items: center;
	}
</style>
